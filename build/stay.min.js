/**
 * stay v0.1.2 build Sep 19 2015
 * https://github.com/vanruesc/stay
 * Copyright 2015 Raoul van Rueschen, Apache-2.0
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Stay=e()}(this,function(){"use strict";function t(){this._listeners={}}function e(t){var e=document.createElement("a");return e.href=t,e.pathname}function i(e){var n=this;if(t.call(this),this.local=new RegExp("^"+location.protocol+"//"+location.host),this.stderr=null,this.infix="/json",this.timeoutPost=6e4,this.timeoutGet=5e3,this.autoUpdate=!0,void 0!==e&&(void 0!==e.stderr&&(this.stderr=e.stderr),void 0!==e.infix&&(this.infix=e.infix),void 0!==e.timeoutPost&&(this.timeoutPost=e.timeoutPost),void 0!==e.timeoutGet&&(this.timeoutGet=e.timeoutGet),void 0!==e.autoUpdate&&(this.autoUpdate=e.autoUpdate)),this.locked=!1,this.backForward=!1,this.absolutePath=null,this.containers=[],this.intermediateContainer=null,this.navigationListeners=[],this.eventNavigate={type:"navigate"},this.eventReceive={type:"receive",response:null,status:0},this.eventLoad={type:"load"},void 0===XMLHttpRequest)throw new Error("XMLHttpRequest not supported.");this.xhr=new XMLHttpRequest,this.xhr.addEventListener("error",function(t){n.dispatchEvent(t)}),this.xhr.addEventListener("readystatechange",function(t){n._handleResponse(this,t)}),this.xhr.addEventListener("timeout",function(){var t={meta:{}};t.meta.title="Timeout Error",null!==n.stderr?t[n.stderr]="<p>"+i.Error.TIMEOUT+"</p>":console.error(i.Error.TIMEOUT),n.locked=!0,n.update(t)}),window.addEventListener("popstate",function(t){n.locked||null===t.state||(n.backForward=!0,n._navigate({href:t.state.url}))}),this._switchPage=function(t){var e=void 0!==t.preventDefault,i=!1;return"submit"===t.type?i=!0:t.metaKey||t.shiftKey||t.altKey||t.ctrlKey||(void 0!==t.which?i=1===t.which:void 0!==t.button&&(i=0===t.button)),i&&(e&&t.preventDefault(),n.locked||n._navigate(this)),!(i&&!e)},this.update({meta:{title:document.title,url:location.href}}),this._updateListeners()}return t.prototype.apply=function(e){e._listeners={},e.addEventListener=t.prototype.addEventListener,e.hasEventListener=t.prototype.hasEventListener,e.removeEventListener=t.prototype.removeEventListener,e.dispatchEvent=t.prototype.dispatchEvent},t.prototype.addEventListener=function(t,e){void 0===this._listeners[t]&&(this._listeners[t]=[]),-1===this._listeners[t].indexOf(e)&&this._listeners[t].push(e)},t.prototype.hasEventListener=function(t,e){return void 0!==this._listeners[t]&&-1!==this._listeners[t].indexOf(e)},t.prototype.removeEventListener=function(t,e){var i,n;n=this._listeners[t],void 0!==n&&(i=n.indexOf(e),-1!==i&&n.splice(i,1))},t.prototype.dispatchEvent=function(t){var e,i,n;if(n=this._listeners[t.type],void 0!==n)for(t.target=this,e=0,i=n.length;i>e;++e)n[e].call(this,t)},i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype._navigate=function(t){var i,n,s,r=!1;this.locked=!0,t.action?(this.absolutePath=t.action,i=new FormData(t),r=!0):this.absolutePath=t.href,n=e(this.absolutePath),"/"!==n.charAt(0)&&(n="/"+n),s="/"===n?this.absolutePath.slice(0,this.absolutePath.length-1)+this.infix+n:this.absolutePath.replace(new RegExp(n),this.infix+n),this.eventNavigate.method=r?"POST":"GET",this.dispatchEvent(this.eventNavigate),this.xhr.open(this.eventNavigate.method,s,!0),r?(this.xhr.timeout=this.timeoutPost,this.xhr.send(i)):(this.xhr.timeout=this.timeoutGet,this.xhr.send())},i.prototype._updateView=function(t){var e,i,n,s=!1;if(null===this.intermediateContainer)this.intermediateContainer=document.createElement("div");else for(;this.intermediateContainer.children.length>0;)this.intermediateContainer.removeChild(this.intermediateContainer.children[0]);for(e in t)if(n=t[e],"object"!=typeof n&&(i=this.containers[e],void 0===i&&(i=this.containers[e]=document.getElementById(e)),null!==i)){for(;i.children.length>0;)i.removeChild(i.children[0]);for(this.intermediateContainer.innerHTML=n;this.intermediateContainer.children.length>0;)i.appendChild(this.intermediateContainer.children[0]);s=!0}s&&this._updateListeners()},i.prototype.unbindListeners=function(){var t,e,i=this;for(t=0,e=this.navigationListeners.length;e>t;++t)this.navigationListeners[t][0].removeEventListener(this.navigationListeners[t][1],i._switchPage)},i.prototype._updateListeners=function(){var t,e,i=this,n=document.getElementsByTagName("a"),s=document.getElementsByTagName("form");for(this.unbindListeners(),t=0,e=n.length;e>t;++t)this.local.test(n[t].href)&&(n[t].addEventListener("click",i._switchPage),this.navigationListeners.push([n[t],"click"]));for(t=0,e=s.length;e>t;++t)this.local.test(s[t].action)&&(s[t].addEventListener("submit",i._switchPage),this.navigationListeners.push([s[t],"submit"]))},i.prototype.update=function(t){var e;if(this._updateView(t),document.title=t.meta.title,t.meta.url&&(this.absolutePath=t.meta.url.replace(this.infix,"")),this.backForward)this.backForward=!1;else try{e=document.origin?document.origin:"null","null"!==e&&history.state&&this.absolutePath!==history.state.url&&history.pushState({url:this.absolutePath},t.meta.title,this.absolutePath)}catch(i){console.warn(i)}this.eventReceive.response=null,this.dispatchEvent(this.eventLoad),this.locked=!1},i.prototype._handleResponse=function(t){var e={meta:{}};if(4===t.readyState){try{e=JSON.parse(t.responseText)}catch(n){e.meta.title="Parse Error",null!==this.stderr&&(e[this.stderr]="<p>"+i.Error.UNPARSABLE+"</p>"),console.error(i.Error.UNPARSABLE)}e.meta.url=t.responseURL,this.eventReceive.status=t.status,this.eventReceive.response=e,this.dispatchEvent(this.eventReceive),this.autoUpdate&&this.update(e)}},i.Error=Object.freeze({TIMEOUT:"The server didn't respond in time. Please try again later!",UNPARSABLE:"The received content could not be parsed."}),i});